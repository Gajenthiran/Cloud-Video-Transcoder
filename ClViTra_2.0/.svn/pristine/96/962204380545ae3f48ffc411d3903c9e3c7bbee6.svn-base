package com.socket.server;

import java.io.File;
import java.util.HashMap;
import org.apache.http.client.HttpClient;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.FileEntity;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.DefaultHttpClient;
import org.json.JSONObject;

public class ObjectStore {

	public String ObjectStoreStart(String filepath) {
		
		//System.out.println("Hello_1");
		return new RetrieveTokenTask().OAuth(filepath);
	}
	
	class RetrieveTokenTask {

		private Exception exception;

		protected String OAuth(String filepath) {
			try {

				HttpClient client = new DefaultHttpClient();

				HttpPost post = new HttpPost(
						"http://137.226.58.11:8081/i5Cloud/services/3/auth");

				StringEntity se = new StringEntity(
						"{\"username\": \"ClViTraUser\", \"password\": \"B74NjN8C\"}");

				post.setEntity(se);
				post.setHeader("Content-type", "application/json");
				
				ResponseHandler responseHandler = new BasicResponseHandler();
				String responseBody = client.execute(post, responseHandler);

				JSONObject jsResponse = new JSONObject(responseBody);
		
				// get token
				String publicURL = jsResponse.getString("swift-url");
				String token = jsResponse.getString("X-Auth-Token");

				HashMap<String, String> values = new HashMap<String, String>();

				values.put("id", token);
				//values.put("publicURL", publicURL);
				values.put("filepath", filepath);
				
				return uploadLastFile(values);
		
			} catch (Exception e) {
				this.exception = e;
				return "error!";
			}
		}
	}
	
	private String uploadLastFile(HashMap<String, String> credentials) {
		//String publicURL = credentials.get("publicURL");
		String token = credentials.get("id");
		String filepath = credentials.get("filepath");
		return new UploadFileTask().Upload(token, filepath);
	}
	
	class UploadFileTask {

		private Exception exception;

		protected String Upload(String... params) {
			try {

				HttpClient client = new DefaultHttpClient();
				
				HttpPut put = new HttpPut("http://137.226.58.11:8081/i5Cloud/services/3/data/" + new File(params[1]).getName()); 

				FileEntity fe = new FileEntity(new File(params[1]), "video/mp4");
				put.setEntity(fe);

				put.setHeader("X-Auth-Token", params[0]);

				ResponseHandler responseHandler = new BasicResponseHandler();
				String responseBody = client.execute(put, responseHandler);
				responseBody = responseBody.substring(18);
				responseBody = responseBody.substring(0, responseBody.length()- 3);
				//System.out.println(responseBody);
				return responseBody;

			} catch (Exception e) {
				this.exception = e;
				return "error!";
			}
		}
	}
}